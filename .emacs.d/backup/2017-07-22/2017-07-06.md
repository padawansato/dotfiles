# ネットワーク上のパケットキャプチャ
これは，スイッチングハブの設定で，自分以外にMACアドレスのパケットを受信する必要がある．
## ミラーリング
ミラーリングとはあるポートで送受信されているトラフィックを別のポートに鏡（ミラー）のように出力する機能
パケットキャプチャ

　トラブル対応では通信がどのように行われているか確認が必要な場合があります。
http://beginners-network.com/image/port_mirror_1.gif


　応用編で説明したフレームはパソコンで収集して確認する事が可能です。フレームを収集する事をパケットキャプチャと言います。キャプチャする場所は、例えばパソコンであったりサーバー側であったりしますが、通信の途中で取りたい時もあります。


　このような時、スイッチにキャプチャ用のパソコンを接続してもキャプチャ出来ません。理由はMACアドレステーブルがあるため、殆どのフレームは接続したパソコンに流れてこないためです。

http://beginners-network.com/image/port_mirror_2.gif
　ポートミラーリングを利用すると設定したインターフェースで流れるフレームを全てコピーして対象のキャプチャ用のパソコンに流す事が出来ます。


http://beginners-network.com/image/port_mirror_3.gif

### ミラーリングやり方
1. ポートミラーリング機能を有効化する
2. ミラーリングの対象となるポート(複製元)を指定する
3. ミラーリング先となるポート(複製先)を指定する
http://news.mynavi.jp/series/networkswitch/006/

# snort
IDS(不正侵入検知)の１つsnort
Snortは監視しているネットワークへの不正な侵入や攻撃を、その手法である「パターンルールセット」（シグネチャ）と照らし合わせ、マッチングしているものを検知し、ログとして記録する
SnortはIDSとしての機能のほかに、「Sniffer Mode」（パケットの閲覧）、「Packet Logger Mode」（パケットのログを記録する）といった機能も持っている

## プロミスキャスモードとは
対象セグメントに流れているすべてのトラフィックを拾うモードです。通常のNICであれば、接続されたネットワークセグメントに流れているトラフィックの内、自アドレスをターゲットとしたトラフィックだけを取り込む仕様ですが、IDSの性格から総てのトラフィックを拾う必要がありますので、Snortでは、Defaultでプロミスキャスモードとなります。(起動時に-pオプションを指定することにより、プロミスキャスモードではなく通常のモードとすることも出来ます)
## ステルスモードとは
読んで字の如く、IDSの存在を隠蔽します。具体的には、監視PortにはIPアドレスを付与しません。これにより、このPortの存在が隠蔽できますし、外部からの攻撃を回避することが出来ます。

## confの設定
```

var HOME_NET any
↓
var HOME_NET  ← 内部ネットワークアドレスを指定

var EXTERNAL_NET any
↓
var EXTERNAL_NET !$HOME_NET ← 内部からのアクセスを不正アクセスとして扱わない

```

## rule ファイル作成
```
# touch /etc/snort/rules/white_list.rules   # rule ファイルを作成
# touch /etc/snort/rules/black_list.rules
```
## 起動スクリプト /etc/sysconfig/snort



## oinkcode
e913282af6e75c7b2b689bb4490f3a8114eb3164


## option
-a ARP パケットを表示
-b tcpdump フォーマットでパケットを記録
-c 設定ファイルを指定
-d アプリケーションレイヤーのデータをダンプ
-e レイヤー2のパケットヘッダをダンプ
-l ログディレクトリを指定
-L バイナリ出力するファイルを指定
-T Snort のテストモード
-u 初期化後に Snort を指定したユーザーで実行 -i   監視したいインターフェースを指定

## テストruleを実行
```
#vim /etc/snort/snort.conf
# site specific rules
#include $RULE_PATH/local.rules

include $RULE_PATH/local.rules ←有効にしたい rule を include する
#snort -c /etc/snort/snort.conf -l /var/log/snort/ -i インターフェース -A fast

## 確認
#tail -f /var/log/snort/alert
log ファイルは pcap 形式で書かれており、tcpdump コマンドで参照

#tcpdump -r /var/log/snort/snort.log.xxxxxxxxxx


## サーバー実行例

```
snort -D -c /etc/snort/snort.conf -l /var/log/snort -i enp9s0 -u snort -g snort -A fast
```


# wireshark
ルータ宛のパケットはルータが接続されたポートにのみ
流れるため、Wiresharkをインストールしたホストが接続された
ポートにはパケットが流れてきません。
そのためパケットのキャプチャをできないわけです。
ではどうすればよいでしょうか？
一番簡単なのはスイッチはハブに変えてしまうことです。http://www.itbook.info/study/wireshark6.html

ミラーリングのできるスイッチングハブを用意し，ミラーポートの設定をする．

## 使い方
### 表示フィルタ
【表示フィルタ例】
フィルタ	例	例でのフィルタ内容説明
ip.addr==	ip.addr==192.168.1.1	192.168.1.1を送信元、又は宛先IPアドレスとするフレーム
ip.src==	ip.src==192.168.1.2	送信元:192.168.1.2のフレーム
ip.dst==	ip.dst==192.168.1.3	宛先192.168.1.3のフレーム
プロトコル	icmp	icmpプロトコルのフレーム(他にはtcp,udp,http,arp等)
tcp.port==	tcp.port==80	TCPポート番号80を送信元、又は宛先とするフレーム
udp.port==	udp.port==53	UDPポート番号53を送信元、又は宛先とするフレーム
　条件式を利用してもう少し複雑なフィルタも書けます。以下に例を示します。

【複雑なフィルタ例】
条件式	フィルタ例	説明
&&	ip.src==102.168.1.2 && ip.dst==192.168.1.3	送信元192.168.1.2、且つ宛先192.168.1.3のフレーム
||	ip.src==102.168.1.2 || ip.dst==192.168.1.3	送信元192.168.1.2、又は宛先192.168.1.3のフレーム
()	(ip.src==192.168.1.2 && ip.dst==192.168.1.3) || (ip.src==192.168.1.4 && ip.dst==192.168.1.5)	送信元192.168.1.2で宛先192.168.1.3、送信元192.168.1.4で宛先192.168.1.5両方のフレーム
　最後の例は()で括る事で数学のように()内が先に判断されます。

　よく使う例の1つは「ip.addr==192.168.1.2 && ip.addr==192.168.1.3 || icmp」です。192.168.1.2と192.168.1.3間の通信を調査したい場合、行きと帰りのフレームを採取するためです。icmpはエラーや通信上の情報を与えてくれてトラブル解決のヒントになる事があるため表示するようにします。


http://beginners-network.com/wireshark.html

### キャプチャフィルタ
「キャプチャフィルタを入力・・・」と記載された所に入力し、その後利用するインターフェースをダブルクリックする事で指定したフレームだけ採取を開始

フィルタ	例	例でのフィルタ内容説明
host	host 192.168.1.1	192.168.1.1を送信元、又は宛先IPアドレスとするフレーム
ip src host	ip src host 192.168.1.2	送信元:192.168.1.2のフレーム
ip dst host	ip dst host 192.168.1.3	宛先192.168.1.3のフレーム
プロトコル	icmp	icmpプロトコルのフレーム(他にはtcp,udp,http,arp等)
tcp port	tcp port 80	TCPポート番号80を送信元、又は宛先
とするフレーム
udp port	udp port 53	UDPポート番号53を送信元、又は宛先とするフレーム
　尚、「&&」、「||」、「()」は表示フィルタと同じように使えます
## Decryption Keyの設定

### 解析
https://mag.osdn.jp/11/07/07/0454255
Wiresharkの強力な解析補助機能を使う


## 学科ルーターの設定　
### cisco
0.0.0.0 10.255.0.1~0.2 でFireWallとL3-SWが通信している．よって，その間をキャプチャすることで，全てのパケットキャプチャしたといえる．

ミラーリングに使うポート
3/0/20
3/0/21

スイッチのカタリストを設定することで，パケットの種類を変えられる．
vlan
361
63　無線　
62  有線
### ssh
サーバールームにあるcentosが入ったノートＰＣを常時接続しておき，必要に応じてssh
で操作できるようにした．
